- 2026-01-29: Audited extension/src for protocol handling/error cases/reliability; reported issues and fixes (popup sendMessage error handling; TabManager lastError handling; CDP close/activate/create target error handling; Target.getTargets info coverage; RelayClient connect concurrency + handshake ack validation). No code changes.
- 2026-01-29: Audited src/relay security paths (origin checks, /pair token flow, handshake validation). Noted issues: permissive Origin handling, /pair token exposure without auth, handshake token type validation; documented fixes. RepoPrompt context builder returned unrelated repo context; ignored.
- 2026-01-29: Audited src/cli and src/tools for correctness/UX/error handling/edge cases; reported issues and proposed fixes (CLI numeric/enum validation, conflicting flags, daemon debug logging, tool arg validation, ensureHub error handling, skill_list error handling). No code changes.
- 2026-01-29: Reviewed docs/TOOL_CLI_PARITY_SPEC.md and docs/TOOLS_CLI_EXPANSION_PLAN.md. Required changes: close remaining parity gaps (CLI-only commands: serve/status --daemon/update/install/uninstall/version/help; tool-only: prompting_guide/skill_list/skill_load); reconcile run semantics (CLI run single-process vs tool run on existing session); implement planned daemon install/uninstall/status from autostart plan; ensure docs/tests align with any parity changes. Status per docs: tool↔CLI mapping and new action/query coverage appear implemented; parity gaps and daemon install/uninstall/status remain open.

## 2026-01-29 — Daemon Autostart Plan/Spec Review
- Reviewed `docs/OPENCODE_DAEMON_AUTOSTART_PLAN.md` and `docs/OPENCODE_DAEMON_AUTOSTART_SPEC.md`.
- Required changes (from plan/spec):
  - Add CLI `daemon install|uninstall|status` subcommands with `--output-format` and exit codes; new handler file and args/index wiring.
  - Implement OS autostart installers (macOS LaunchAgent + Windows Task Scheduler) using absolute CLI entrypoints; uninstall removes services and stops daemon.
  - Implement `daemon status` reporting `{ installed, running, status? }` without usage error when missing.
  - Add extension auto-retry/backoff for `/config` + `/pair` (prefer `chrome.alarms` + permission), with tests/mocks updates.
  - Docs updates: CLI docs + parity spec + deprecation note in spec.
- Implementation status (verified in repo):
  - CLI daemon subcommands: NOT implemented (no `src/cli/commands/daemon.ts`, no args/index wiring).
  - OS autostart installers: NOT implemented (no LaunchAgent/Task Scheduler logic in `src/cli/daemon.ts`).
  - `daemon status` semantics: NOT implemented as spec (only `status` command exists; no installed/running reporting).
  - Extension auto-retry/backoff: NOT implemented in `extension/src/background.ts` (no alarms/backoff). Tests/mocks not updated.
  - Docs: `docs/CLI.md` and `docs/TOOL_CLI_PARITY_SPEC.md` already mention daemon commands as planned; spec already marked superseded.
- 2026-01-29: Investigated relay config unreachable / auto-pair failures. Likely root causes: (1) extension background auto-connect always fetches /config on DEFAULT_DISCOVERY_PORT and, on failure, clears stored relayPort/token then falls back to DEFAULT_RELAY_PORT; if discovery server is down or non-default, /pair hits wrong port and fails. (2) relay /config and /pair require Authorization for no-Origin requests when pairingToken set; CLI/browser-manager calls without relayToken get 401, reported as config unreachable/token fetch failure. Suggested fixes: preserve stored relayPort when /config fails and try stored port as fallback; do not clear stored relay state on config fetch failure; add clearer error when /config or /pair 401 due to missing relayToken (or allow /config for loopback without token if desired).
- 2026-01-30: Reviewed relay HTTP origin/CORS/PNA changes (src/relay/relay-server.ts, tests/relay-server.test.ts). Findings: Origin "null" is normalized to undefined and explicitly CORS-allowed, which can let null-origin sandboxed contexts read /pair or /config and, combined with /cdp upgrade logic, bypass origin checks (CSWSH risk). Recommended fix: treat "null" as a real origin and block unless extension; remove Access-Control-Allow-Origin: null and Access-Control-Allow-Private-Network for null, and add tests for /cdp + HTTP rejects. Also noted authorizeHttpRequest error paths omit CORS headers for extension origins, so 403/429 surface as CORS failures; consider adding allow-origin on error for extension only. No code changes.
- 2026-01-31: Analyzed pi-annotate extension UX + commands for parity (features + implementation hints, with refs).
  - /annotate command + annotate tool (optional URL; starts annotation; formats results; writes screenshots to tmp) — `_research/pi-annotate/index.ts`
  - Chrome command shortcut toggle-picker + popup Start Annotation routed through background injection — `_research/pi-annotate/chrome-extension/manifest.json`, `_research/pi-annotate/chrome-extension/popup.js`, `_research/pi-annotate/chrome-extension/background.js`
  - Popup connection UX: status indicator, copy Extension ID/install command, PING/PONG health check, trouble states — `_research/pi-annotate/chrome-extension/popup.html`, `_research/pi-annotate/chrome-extension/popup.js`, `_research/pi-annotate/chrome-extension/native/host.cjs`
  - Native host bridge: Unix socket + token auth, session replacement, log redaction/rotation — `_research/pi-annotate/chrome-extension/native/host.cjs`
  - Background routing: restricted URL detection, open new tab/navigate + inject, requestId→tab mapping, screenshot capture — `_research/pi-annotate/chrome-extension/background.js`
  - Content script UX: hover highlight + tooltip, wheel to cycle ancestors, click/shift multi-select, note cards w/ comments + drag, badges/connectors, screenshot modes (crop/full/none), debug capture, context input, submit/cancel (ESC) — `_research/pi-annotate/chrome-extension/content.js`
- 2026-01-31: Analyzed pi-annotate extension connection patterns (background/content/native/popup). Key behaviors for connection/auth/stability: background service worker connects to native host `com.pi.annotate`, forwards messages to content scripts, auto-reconnects after disconnect, and routes START_ANNOTATION by opening/navigating tabs with a restricted-URL guard, requestId→tab mapping, and a 30s navigation timeout; injects `content.js` if missing before sending messages; captures screenshots on request and forwards ANNOTATIONS_COMPLETE/CANCEL back to native host. (`_research/pi-annotate/chrome-extension/background.js:20`, `_research/pi-annotate/chrome-extension/background.js:32`, `_research/pi-annotate/chrome-extension/background.js:56`, `_research/pi-annotate/chrome-extension/background.js:95`, `_research/pi-annotate/chrome-extension/background.js:116`, `_research/pi-annotate/chrome-extension/background.js:157`, `_research/pi-annotate/chrome-extension/background.js:175`, `_research/pi-annotate/chrome-extension/background.js:193`)
- 2026-01-31: Content script prevents double-injection, handles START_ANNOTATION/TOGGLE_PICKER/CANCEL, requests CAPTURE_SCREENSHOT via background, and sends result payloads (ANNOTATIONS_COMPLETE/CANCEL) back. (`_research/pi-annotate/chrome-extension/content.js:12`, `_research/pi-annotate/chrome-extension/content.js:579`, `_research/pi-annotate/chrome-extension/content.js:2250`, `_research/pi-annotate/chrome-extension/content.js:2290`, `_research/pi-annotate/chrome-extension/content.js:2312`, `_research/pi-annotate/chrome-extension/content.js:2329`)
- 2026-01-31: Popup health check uses connectNative PING/PONG with 3s timeout, interprets lastError for not found/forbidden, and offers retry + UI state changes. (`_research/pi-annotate/chrome-extension/popup.js:108`, `_research/pi-annotate/chrome-extension/popup.js:127`, `_research/pi-annotate/chrome-extension/popup.js:149`)
- 2026-01-31: Native host (Node) implements Chrome native messaging framing, responds to PING with PONG, bridges to Pi over Unix socket `/tmp/pi-annotate.sock`, creates auth token at `/tmp/pi-annotate.token` (0600), requires AUTH before forwarding, replaces existing Pi client, enforces buffer limits, rotates logs, and cleans up socket/token on exit. (`_research/pi-annotate/chrome-extension/native/host.cjs:5`, `_research/pi-annotate/chrome-extension/native/host.cjs:37`, `_research/pi-annotate/chrome-extension/native/host.cjs:53`, `_research/pi-annotate/chrome-extension/native/host.cjs:92`, `_research/pi-annotate/chrome-extension/native/host.cjs:135`, `_research/pi-annotate/chrome-extension/native/host.cjs:162`, `_research/pi-annotate/chrome-extension/native/host.cjs:178`, `_research/pi-annotate/chrome-extension/native/host.cjs:209`, `_research/pi-annotate/chrome-extension/native/host.cjs:122`)
- 2026-01-31: Native messaging install script writes manifest with allowed_origins locked to extension ID and uses a wrapper script with absolute node path to avoid PATH issues. (`_research/pi-annotate/chrome-extension/native/install.sh:33`, `_research/pi-annotate/chrome-extension/native/install.sh:51`)
- 2026-01-31: Manifest declares MV3 service worker, content script at document_idle, permissions for activeTab/nativeMessaging/scripting and <all_urls> host permissions. (`_research/pi-annotate/chrome-extension/manifest.json`)
- 2026-01-31: Pi-annotate parity feature list (extension capabilities, UX flows, commands, implementation hints) with file refs.
  - Commands/entrypoints: `/annotate` command + `annotate` tool (URL optional, timeout, formatted markdown output with screenshots) — `_research/pi-annotate/index.ts`
  - Extension shortcuts: `toggle-picker` command (Ctrl/⌘+Shift+P) + popup Start button that routes through background injection — `_research/pi-annotate/chrome-extension/manifest.json`, `_research/pi-annotate/chrome-extension/popup.js`, `_research/pi-annotate/chrome-extension/background.js`
  - Popup UX: status indicator, copy extension ID/install command, PING/PONG health check, connected/not-installed/trouble states, retry — `_research/pi-annotate/chrome-extension/popup.html`, `_research/pi-annotate/chrome-extension/popup.js`, `_research/pi-annotate/chrome-extension/native/host.cjs`
  - Background routing: native host connect/reconnect, restricted URL detection, open new tab or navigate then inject, requestId→tab mapping, fallback inject on missing content script, screenshot capture via `captureVisibleTab` — `_research/pi-annotate/chrome-extension/background.js`
  - Content script UX: hover highlight + tooltip, wheel cycles ancestor stack, click select (shift/multi mode), draggable note cards with comments + badges/connectors, selector click scrolls, expand/contract to parent/child, remove element, global notes toggle, selection count, context input, submit/cancel (ESC) — `_research/pi-annotate/chrome-extension/content.js`
  - Data capture: selector/tag/id/classes/text/rect/attributes, box model, accessibility info, key styles; debug mode adds computed styles, parent context, CSS variables — `_research/pi-annotate/chrome-extension/content.js`, `_research/pi-annotate/types.ts`
  - Screenshot modes: per-element crop (padding), full-page screenshot with numbered badges, or none; hides UI before capture — `_research/pi-annotate/chrome-extension/content.js`, `_research/pi-annotate/chrome-extension/background.js`
  - Native host bridge: Unix socket `/tmp/pi-annotate.sock` + auth token `/tmp/pi-annotate.token` (0600), session replacement, log redaction/rotation, PING→PONG — `_research/pi-annotate/chrome-extension/native/host.cjs`, `_research/pi-annotate/chrome-extension/native/install.sh`
- 2026-01-31: Summarized `docs/PI_ANNOTATE_PARITY_PLAN.md`. Required changes: stabilize extension mode (target readiness gating, session filtering/recovery, relay health check, popup/CLI diagnostics), add annotation side-channel protocol + validation/limits, add node annotation manager + tool, implement injected annotation UI (selection, notes, data capture, redaction), add visible-only and full-page screenshot pipelines, wire shortcut, and add docs/tests; optional Phase 2 native messaging fallback + CLI integration. Key files: `src/browser/browser-manager.ts`, `extension/src/services/TabManager.ts`, `extension/src/services/cdp-router-commands.ts`, `extension/src/services/CDPRouter.ts`, `extension/src/services/TargetSessionMap.ts`, `src/relay/protocol.ts`, `src/relay/relay-server.ts`, `extension/src/popup.tsx`, `src/cli/commands/status.ts`, `extension/src/background.ts`, `extension/src/types.ts`, `src/browser/annotation-manager.ts`, `src/core/bootstrap.ts`, `src/tools/annotate.ts`, `src/tools/index.ts`, `extension/src/annotate-content.ts`, `extension/src/annotate-content.css`, `extension/manifest.json`, `docs/CLI.md`, `docs/ANNOTATE.md`, `tests/relay-server.test.ts`, `tests/tools-annotate.test.ts`, `tests/extension-background.test.ts`, `tests/browser-manager.test.ts`, `scripts/native/host.cjs`, `scripts/native/install.sh`, `scripts/native/uninstall.sh`, `src/cli/commands/native.ts`.
- 2026-01-31: Mapped current codebase for pi-annotate parity. Existing related pieces: relay protocol/server (`src/relay/protocol.ts`, `src/relay/relay-server.ts`, `src/relay/relay-types.ts`), extension connection + routing (`extension/src/background.ts`, `extension/src/services/ConnectionManager.ts`, `extension/src/services/RelayClient.ts`, `extension/src/services/CDPRouter.ts`, `extension/src/services/TargetSessionMap.ts`, `extension/src/services/cdp-router-commands.ts`, `extension/src/services/TabManager.ts`, `extension/src/types.ts`), popup + manifest (`extension/src/popup.tsx`, `extension/manifest.json`), selector/snapshot pipeline (`src/snapshot/snapshotter.ts`, `src/snapshot/refs.ts`, `src/tools/snapshot.ts`), screenshot + DOM capture/export (`src/tools/screenshot.ts`, `src/browser/browser-manager.ts`, `src/export/dom-capture.ts`, `src/export/react-emitter.ts`, `src/tools/clone_component.ts`, `src/tools/clone_page.ts`), DOM helpers (`src/tools/dom_get_html.ts`, `src/tools/dom_get_text.ts`, `src/tools/get_attr.ts`, `src/tools/get_value.ts`), tool registry (`src/tools/index.ts`), daemon routing for screenshot (`src/cli/daemon-commands.ts`, `src/cli/remote-manager.ts`). Likely files to touch for parity: add new annotate manager + tool (`src/browser/annotation-manager.ts`, `src/tools/annotate.ts`, `src/tools/index.ts`), extend relay schema (`src/relay/protocol.ts`, `src/relay/relay-types.ts`, `src/relay/relay-server.ts`, `extension/src/types.ts`, `extension/src/services/RelayClient.ts`), extension UI + injection (`extension/src/background.ts`, `extension/src/popup.tsx`, `extension/manifest.json`, new `extension/src/annotate-content.ts` + `extension/src/annotate-content.css`), and tests/docs (`tests/*annotate*`, `docs/ANNOTATE.md`, `docs/CLI.md`).
- 2026-01-31: Added annotate tool tests covering formatting output, redaction, screenshot tmp path, and timeout behavior in `tests/tools-annotate.test.ts`.
- 2026-01-31: Checked Vitest coverage setup/tests. `vitest.config.ts` uses v8 coverage with include `src/**/*.ts`, excludes `extension/**`, `src/cli/**`, `src/extension-extractor.ts`, `src/tools/{skill_list,skill_load}.ts`, etc; thresholds set to 97% for lines/functions/branches/statements. `tests/AGENTS.md` notes coverage scope is `src/**/*.ts` only (extension excluded). Extension tests exist for `extension/src/services/{RelayClient,ConnectionManager,CDPRouter}` and `extension/src/background.ts`, but no tests found for `extension/src/TabManager.ts`, `TargetSessionMap.ts`, `cdp-router-commands.ts`, or `popup.tsx`. No tests reference annotate; annotate code appears only under `_research/pi-annotate/` (outside coverage scope).
- 2026-01-31: Updated `tests/browser-manager.test.ts` to cover extension target readiness gating before navigation and retry behavior when navigation hits a detached frame; added frame mocks for readiness checks.
- 2026-01-31: Updated tests/relay-server.test.ts with annotation WS routing coverage and status lastHandshakeError/health clearing assertions.
- 2026-02-01: Reviewed relay heartbeat/reconnect/state resync in extension service layer. RelayClient has no automatic heartbeat loop; only responds to explicit `sendHealthCheck`/`sendPing` (creates `ping` with UUID, waits for `pong`, 1.5s timeout) and resolves pending maps on incoming `pong`/`healthCheckResult`, clearing them on socket close. Handshake ack enforced with 2s timeout; close clears pending handshake/health/pings and triggers onClose. (`extension/src/services/RelayClient.ts:39-166`, `extension/src/services/RelayClient.ts:120-138`, `extension/src/services/RelayClient.ts:198-216`). ConnectionManager exposes `relayHealthCheck` but never schedules it; no heartbeat loop, just ad-hoc check. Reconnect loop: on relay close, if `shouldReconnect` and `trackedTab` present, status set to disconnected, relay identity cleared, then scheduleReconnect with exponential backoff (500ms doubling to 5s) and `reconnectRelay` attempts; failures reschedule. (`extension/src/services/ConnectionManager.ts:345-388`, `extension/src/services/ConnectionManager.ts:360-371`). Reconnect path refreshes tracked tab from current primary CDP tab, then re-handshakes to relay; no explicit CDP state resync besides reusing existing CDP attachments and re-sending handshake metadata (tab id/url/title/group, pairing token). Handshake is also resent on tab updates and primary tab change. (`extension/src/services/ConnectionManager.ts:374-406`, `extension/src/services/ConnectionManager.ts:441-454`, `extension/src/services/ConnectionManager.ts:558-568`, `extension/src/services/ConnectionManager.ts:591-595`).
- 2026-02-01: Inspected extension relay binding/state contention. Found relay + CDP state is singleton per background service worker (ConnectionManager/RelayClient/CDPRouter single instances), not per-tab. Disconnect clears all CDP attachments and shared session maps; relay handshake tied to single tracked primary tab and re-sent on primary changes. Evidence: extension/src/background.ts:30-38, 1039-1054; extension/src/services/ConnectionManager.ts:90-110, 199-217, 293-333, 391-408, 432-438, 558-568; extension/src/services/CDPRouter.ts:28-39, 102-115, 426-436; extension/src/services/TargetSessionMap.ts:27-150.
- 2026-02-01: Scanned extension code for silent failure patterns. Found multiple empty promise catches (.catch(() => {})) and swallowed errors (catch blocks returning null or ignoring errors) across extension background/services/popup/annotate content; reported file+line refs in response. No code changes.
- 2026-02-01: Reviewed heartbeat/liveness + reconnect + relay identity handling in extension relay layer. Observed: RelayClient has no background heartbeat loop; ping/pong only on-demand via sendPing/sendHealthCheck. ConnectionManager never schedules relayHealthCheck; reconnect logic clears relay identity but does not reconcile instanceId/epoch on reconnect beyond persisting ack. Proposed minimal changes: add heartbeat timer that calls RelayClient.sendPing on interval and forces disconnect on timeout/missed pong; track consecutive misses. Add RelayClient heartbeat helper with lastPongAt/missedPongs and stop on socket close. On connectRelay, compare new ack instanceId/epoch with prior stored values; if changed, log + update stored identity and optionally trigger a lightweight state resync (re-send handshake, reset backoff, and clear any relay-dependent caches if added later).

- 2026-02-01: Scanned extension files for silent failure patterns (empty catch, .catch(() => {}), swallowed errors). Findings with line refs in: `extension/src/background.ts` (33, 68, 137-141, 255, 264-268, 331-333, 364-366, 406, 412-416, 562-567, 821, 835, 850, 865, 906-908, 1031-1033, 1058, 1062, 1069, 1077, 1082, 1089, 1092, 1103-1109, 1116-1129, 1134-1148, 1213-1217, 1279-1287), `extension/src/services/ConnectionManager.ts` (75-79, 114, 155-158, 250-254, 299-302, 317, 320, 368-369, 380-381, 385-386, 428, 437), `extension/src/services/CDPRouter.ts` (358, 398, 562-564), `extension/src/annotate-content.ts` (151), `extension/src/popup.tsx` (238-240, 281-283, 360-363, 370-372, 438-441, 460-464, 492-495, 514-517, 550-553, 555-563, 565-568), `extension/src/services/RelayClient.ts` (243-246). Suggested replacing each silent catch with a structured logging helper (e.g., `logExtensionError(context, error, extra)`), preserving fallback behavior while emitting context + error details.
- 2026-02-01: Inspected src/browser/annotation-manager.ts for branch coverage gaps; suggested minimal tests to cover direct assets missing -> direct_unavailable; auto mode with sessionId returning ok/cancelled (no relay); auto mode direct error with non direct_* code (no fallback); auto mode direct_failed but no relay endpoint or status!=extension (no fallback); ignore unknown relay message type; requireExtension true with sessionId but no manager (proceeds to relay path).
- 2026-02-01: Inspected coverage for src/annotate/direct-annotator.ts; identified missing branches and proposed minimal tests (abort signal after start; re-run on same page to cover cached completion map/binding/shim; non-binding exposeBinding errors; missing ping response; runtime.sendMessage edge cases including missing type/capture binding, capture throw, invalid completion payloads; annotation:error without code/message; string error "has been already exposed" for isBindingExistsError). No code changes.
- 2026-02-01: Audited CLI/extension/testing docs vs implementation. Findings: `src/cli/AGENTS.md` should reflect current CLI command surface (install/update/uninstall/serve/daemon/native/run/launch/connect/disconnect/status + navigation/interact/dom/devtools/export + annotate), registration in `src/cli/index.ts` + command parsing in `src/cli/args.ts`, and include new files (`daemon-autostart.ts`, `daemon-commands.ts`, `daemon-status.ts`, `daemon-client.ts`, `daemon-state.ts`, `remote-relay.ts`). `extension/AGENTS.md` should mention ConnectionManager/RelayClient/NativePortManager, annotation transport, relay health/handshake ack (instanceId/epoch), heartbeat + reconnect/backoff via alarms, and TargetSessionMap root/child session routing (flat sessions, primary tab + multi-session). `tests/AGENTS.md` should match `vitest.config.ts` thresholds (97%) and note coverage exclusions (CLI, extension, relay/protocol, skill_list/skill_load, etc.). `src/AGENTS.md` tool count should be updated from 40 to 41.

- 2026-02-01: Verified tool registry in src/tools/index.ts: 41 tools total including opendevbrowser_annotate. Tool-only (no CLI command) entries: opendevbrowser_prompting_guide, opendevbrowser_skill_list, opendevbrowser_skill_load.
- 2026-02-01: Ran relay CLI coverage script `/tmp/odb-cli-relay.mjs`. Daemon status OK with extension connected/handshake OK but `cdpConnected=true`. `launch --extension-only` failed (`Only one CDP client supported` on ws://127.0.0.1:8787/cdp), so session-dependent commands were skipped. `run` command (managed headless) succeeded with snapshot. Outputs captured in `/tmp/odb-cli-relay-results.json`.
- 2026-02-02: Scanned extension/AGENTS.md + docs/EXTENSION.md for /ops WS constraints. Must keep relay local-only, no hardcoded URLs, no token/content logging; use popup-configured relayPort/relayToken. Extension relies on Chrome 125+ flat sessions, top-level tab discovery with child auto-attach, primary-tab handshake/status, and CDPRouter multiplexing for multi-client /cdp. Auto-connect/auto-pair flow uses /config then /pair; /cdp requires token when pairing enabled; restricted tabs (chrome:// etc.) and DevTools debugger conflicts block attach; hub mode makes hub daemon sole relay owner (FIFO leases, no local fallback).
- 2026-02-02: Reviewed relay WS patterns in `src/relay/relay-server.ts`, `src/relay/protocol.ts`, `src/relay/relay-types.ts` for /ops planning. Existing endpoints: HTTP `GET/OPTIONS /config`, `GET/OPTIONS /status`, `GET/OPTIONS /pair` (token + instanceId/epoch); WS upgrades for `/extension`, `/cdp`, `/annotation`. Auth/origin/rate limits: extension WS requires `chrome-extension://` Origin and rate-limits; `/cdp` and `/annotation` accept extension-origin or loopback without Origin, both require token query `?token=` when pairing enabled; HTTP endpoints allow extension origin or loopback IP; HTTP has separate rate limiter. Routing: /cdp forwards CDP commands from client to extension (`forwardCDPCommand`) and sends extension events/responses back; allowlist optional. /annotation uses separate WS client with `annotationCommand`/`annotationResponse`/`annotationEvent` envelope types, enforces pending request tracking, payload size limit, and timeouts; extension handles command, relay forwards responses/events back to annotation client. Health/ping shared for extension and annotation sockets.
- 2026-02-02: Reviewed extension connection patterns (background/RelayClient/ConnectionManager + annotation routing). Summarized handshake, ping/health, reconnect, and annotation channel handling; noted how a new /ops WS should mirror handshake/heartbeat and could reuse RelayClient patterns.
- 2026-02-02: Scanned RelayHealthStatus/RelayStatus usage. Found local test/types that omit opsConnected/annotationConnected/health/epoch fields and launch diagnostics that ignore opsConnected. Suggested updates in response; no code changes.
- 2026-02-02: Scanned CLI extension-mode flags and routing for ops-default vs legacy per EXTENSION_OPS_WS_SPEC_PLAN. Findings: only `--no-extension`, `--extension-only`, `--wait-for-extension`, `--wait-timeout-ms` exist (src/cli/args.ts, src/cli/commands/session/launch.ts); no `--extension-legacy` (or `--extension-ops`). Extension-mode launch/connect still use relay `/cdp` by default (src/cli/daemon-commands.ts: launchWithRelay/connectWithRelayRouting; normalizeRelayEndpoint + relayUrl), and docs state relay `/cdp` normalization (docs/CLI.md) and flag semantics (docs/CLI.md, src/AGENTS.md). Recommended changes: add `--extension-legacy` flag in arg validation/help/launch parsing; make ops default routing in launch/connect with legacy opt-in for `/cdp`; update extension readiness/error messaging to suggest `--extension-legacy` on ops failure; update docs/CLI.md + src/AGENTS.md to reflect ops default, legacy opt-in, and new flag precedence with `--no-extension`/`--headless`/`--extension-only`.
- 2026-02-02: Reviewed extension code + docs/EXTENSION_OPS_WS_SPEC_PLAN.md for OpsRuntime integration points. Recommended wiring in extension/src/background.ts: instantiate separate OpsRuntime + Ops WS client alongside ConnectionManager/NativePortManager; hook into autoConnect/popup connect/disconnect to connect/disconnect /ops using same relayPort/pairing token; reuse CDPRouter+TargetSessionMap+TabManager inside a CDPAdapter for ops-owned tabs; reuse existing restricted URL and injection patterns for DomBridge; keep /annotation path untouched; update badge/effective status and status note paths to account for ops connectivity (relay health already exposes opsConnected). Suggested minimal file layout: extension/src/ops/ops-runtime.ts, ops-session-store.ts, cdp-adapter.ts, dom-bridge.ts (+ optional ops-ws client patterned after RelayClient if not embedded in ops-runtime).
- 2026-02-02: Scanned tests for relay status/health updates. Missing opsConnected (and related fields) in mocks/expectations in tests/extension-relay-client.test.ts, tests/extension-connection-manager.test.ts, tests/relay-server.test.ts (status/health assertions), tests/remote-relay.test.ts (status + opsUrl expectations), tests/daemon-commands.integration.test.ts (RelayStatus type/defaults), tests/tools.test.ts (relay.status mocks + observed /status payloads), and tests/core-bootstrap.test.ts (RelayStatus mock type). Suggested adding opsConnected/annotationConnected/health/epoch fields and opsUrl assertions where relevant.
- 2026-02-02: Audited tool-only commands for Ops WS Task 1; confirmed prompting_guide/skill_list/skill_load use deps.skills only (no BrowserManager/relay); suggested docs/CLI.md note location.
- 2026-02-02: Audited src/cli/daemon-commands.ts for binding-only enforcement. Findings: no requireBindingForSession; requireBinding used in annotate extension path, authorizeSessionCommand fallback when no lease, and disconnectSession fallback; legacy /cdp paths still require binding. Suggested: replace annotate + extension session authorization to lease-based (require leaseId/ownership), and fail when lease missing except explicit legacy mode.
- 2026-02-02: Scanned ops lease/warning test expectations; ops-browser-manager tests use toHaveBeenCalledWith for ops client requests and will fail now that request() includes timeout/leaseId args (suggest loosening assertions to ignore extra args or expect timeout+lease). No direct lease/warning assertion failures found in daemon-client or tools tests.
- 2026-02-02: Extracted validation steps from docs/ANNOTATE.md + docs/EXTENSION.md for /annotation + extension mode. Prereqs: Chrome 125+, extension installed/unpacked, relay daemon running, extension popup shows Connected, pairing token configured/auto-pair, annotation assets built if using direct path. Manual steps: run `npx opendevbrowser --full`, load unpacked extension, open popup configure relay port/auto-connect/auto-pair, start daemon `npx opendevbrowser serve`, confirm popup Connected, then run annotate in extension session: `npx opendevbrowser annotate --session-id <id> --transport relay --tab-id <tab>` or use popup Annotate UI; verify output includes markdown summary and screenshots in tmp. /annotation relay validation: ensure session is extension mode, relay ws `/annotation` available via running daemon + extension connected; use annotate tool/CLI and confirm JSON output contains `data.details` and `data.screenshots` paths; troubleshoot restricted URLs and injection failures.
- 2026-02-02: Inspected docs/CLI.md + docs/TROUBLESHOOTING.md and tests for /ops vs /cdp validation guidance. Docs: extension relay default uses /ops; `--extension-legacy` routes via /cdp; connect to local relay normalizes to /ops unless legacy; status fields to confirm include extensionConnected, extensionHandshakeComplete, opsConnected, cdpConnected, pairingRequired. Troubleshooting notes `status --daemon` legend and that `cdpConnected` is expected false until a legacy /cdp session connects.
- 2026-02-02: Inspected coverage for BrowserManager/TargetManager. Missing spy in tests/browser-manager.test.ts "selects a stable http page when the active tab is blank" (add TargetManager.setActiveTarget spy before BrowserManager import). Lcov gaps in src/browser/browser-manager.ts lines 221, 308-309, 523, 535, 538, 571, 588, 603, 606, 632, 1023, 1028; src/browser/target-manager.ts line 188. Suggested tests: withPage managed+extension, disconnect without page listener, fallback selection on timeout/detached when entries empty or non-http, helper string inputs, and syncPages removal for unnamed target.
